{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load number_filters %}

{% block title %}Seller Analytics Dashboard{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css" rel="stylesheet">
<style>
.metric-card {
    transition: transform 0.2s;
}
.metric-card:hover {
    transform: translateY(-5px);
}
.trend-indicator {
    font-size: 0.8rem;
}
.trend-up { color: #28a745; }
.trend-down { color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Seller Analytics Dashboard</h1>
        <div class="d-flex gap-2">
            <form method="get" class="d-flex gap-2">
                <select name="period" class="form-select" style="width: auto;" onchange="this.form.submit()">
                    <option value="24h" {% if period == '24h' %}selected{% endif %}>Last 24 Hours</option>
                    <option value="7d" {% if period == '7d' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30d" {% if period == '30d' %}selected{% endif %}>Last 30 Days</option>
                    <option value="all" {% if period == 'all' %}selected{% endif %}>All Time</option>
                </select>
            </form>
        </div>
    </div>

    <!-- Overall Performance Metrics -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Total Revenue</h6>
                    <h2 class="card-title mb-1">KSh {{ total_revenue|intcomma }}</h2>
                    <div class="trend-indicator {% if revenue_trend > 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if revenue_trend > 0 %}up{% else %}down{% endif %}"></i>
                        {{ revenue_trend|abs_value }}% vs previous
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Total Orders</h6>
                    <h2 class="card-title mb-1">{{ total_orders|intcomma }}</h2>
                    <div class="trend-indicator {% if orders_trend > 0 %}trend-up{% else %}trend-down{% endif %}">
                        <i class="fas fa-arrow-{% if orders_trend > 0 %}up{% else %}down{% endif %}"></i>
                        {{ orders_trend|abs_value }}% vs previous
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Active Stores</h6>
                    <h2 class="card-title mb-1">{{ active_stores }}</h2>
                    <div class="text-muted small">
                        {{ premium_stores }} Premium
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Active Listings</h6>
                    <h2 class="card-title mb-1">{{ active_listings|intcomma }}</h2>
                    <div class="text-muted small">
                        Across all stores
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue & Orders Charts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Revenue & Orders Trend</h5>
                    <canvas id="revenueOrdersTrend"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Store Performance</h5>
                    <canvas id="storePerformance"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Rankings & Categories -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Top Performing Stores</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Store</th>
                                    <th>Revenue</th>
                                    <th>Orders</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for store in top_stores %}
                                <tr>
                                    <td>
                                        <a href="{% url 'storefront:store_analytics' store.slug %}">
                                            {{ store.name }}
                                        </a>
                                    </td>
                                    <td>KSh {{ store.revenue|intcomma }}</td>
                                    <td>{{ store.orders|intcomma }}</td>
                                    <td>{{ store.rating|floatformat:1 }}â˜…</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Top Categories</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Revenue</th>
                                    <th>Orders</th>
                                    <th>Listings</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in top_categories %}
                                <tr>
                                    <td>{{ category.name }}</td>
                                    <td>KSh {{ category.revenue|intcomma }}</td>
                                    <td>{{ category.orders|intcomma }}</td>
                                    <td>{{ category.listings|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity & Customer Map -->
    <div class="row g-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Store</th>
                                    <th>Type</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recent_activity %}
                                <tr>
                                    <td>{{ activity.timestamp|date:"M d, H:i" }}</td>
                                    <td>{{ activity.store }}</td>
                                    <td>{{ activity.type }}</td>
                                    <td>{{ activity.description }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Customer Map</h5>
                    <canvas id="customerMap"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Revenue & Orders Trend Chart
    new Chart(document.getElementById('revenueOrdersTrend'), {
        type: 'line',
        data: {{ revenue_orders_trend_data|safe }},
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                },
            }
        },
    });

    // Store Performance Chart
    new Chart(document.getElementById('storePerformance'), {
        type: 'doughnut',
        data: {{ store_performance_data|safe }},
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // Customer Map Chart
    new Chart(document.getElementById('customerMap'), {
        type: 'pie',
        data: {{ customer_map_data|safe }},
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
});
</script>
{% endblock %}