{% extends 'base.html' %}
{% load static custom_filters %}
{% load humanize %}

{% block title %}All Listings - Baysoko Marketplace{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced All Listings Styles */
    .listings-hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        color: white;
        padding: var(--spacing-xl) 0;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .listings-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('{% static "images/pattern.svg" %}') center/cover;
        opacity: 0.1;
    }

    .listings-hero-content {
        position: relative;
        z-index: 2;
        max-width: 800px;
        margin: 0 auto;
    }

    .listings-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: var(--spacing-sm);
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .listings-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
        line-height: 1.6;
    }

    /* Search Section - More Compact */
    .search-section {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin: calc(-1 * var(--spacing-lg)) auto var(--spacing-lg);
        max-width: 700px;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        position: relative;
        z-index: 10;
    }

    .search-form {
        display: flex;
        gap: var(--spacing-sm);
        width: 100%;
    }

    .search-input {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition);
        outline: none;
    }

    .search-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .search-button {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        white-space: nowrap;
    }

    .search-button:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    /* Main Content Layout - Optimized for maximum listings */
    .listings-layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: var(--spacing-lg);
        align-items: start;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-md);
    }

    /* Ultra-Compact Filters Sidebar */
    .filters-sidebar {
        position: sticky;
        top: 80px;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        transition: var(--transition);
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .filters-sidebar:hover {
        box-shadow: var(--shadow-lg);
    }

    .filters-header {
        background: var(--primary);
        color: white;
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .filters-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .filters-body {
        padding: var(--spacing-md);
    }

    .filter-group {
        margin-bottom: var(--spacing-md);
    }

    .filter-label {
        display: block;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .filter-select,
    .filter-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.85rem;
        transition: var(--transition);
        outline: none;
    }

    .filter-select:focus,
    .filter-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .price-range {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xs);
    }

    .quick-filters {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .quick-filter {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        text-align: left;
        cursor: pointer;
        transition: var(--transition);
        color: var(--text-primary);
        font-size: 0.8rem;
    }

    .quick-filter:hover {
        border-color: var(--primary);
        background: rgba(255, 107, 53, 0.05);
    }

    .filter-actions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-md);
    }

    .filter-button {
        padding: 10px 12px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border: none;
    }

    .filter-button-primary {
        background: var(--primary);
        color: white;
    }

    .filter-button-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .filter-button-secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .filter-button-secondary:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--primary);
    }

    /* Listings Header Bar - More Compact */
    .listings-header-bar {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
    }

    .results-info h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 4px 0;
        color: var(--text-primary);
    }

    .results-count {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .sort-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .sort-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .sort-select {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 8px 12px;
        color: var(--text-primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: var(--transition);
        outline: none;
    }

    .sort-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    /* Active Filters */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
    }

    .filter-tag {
        background: var(--primary);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-tag-remove {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 2px;
        border-radius: 50%;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .filter-tag-remove:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Enhanced Listings Grid - 3 cards per row on desktop, 2 on mobile */
    .listings-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
    }

    /* Ultra-Compact Listing Cards with Title on Image */
    .listing-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .listing-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .listing-image {
        position: relative;
        height: 160px;
        overflow: hidden;
        background: var(--bg-secondary);
    }

    .listing-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition-slow);
    }

    .listing-card:hover .listing-image img {
        transform: scale(1.05);
    }

    /* Title Overlay on Image */
    .listing-title-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
        color: white;
        padding: var(--spacing-sm);
        z-index: 2;
    }

    .listing-title {
        font-weight: 700;
        font-size: 0.9rem;
        line-height: 1.2;
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .listing-badges {
        position: absolute;
        top: var(--spacing-xs);
        left: var(--spacing-xs);
        right: var(--spacing-xs);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .listing-category {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
        backdrop-filter: blur(20px);
        display: flex;
        align-items: center;
        gap: 3px;
    }

    .listing-status {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .listing-sold {
        background: var(--danger);
        color: white;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 600;
    }

    .listing-favorite {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: blur(20px);
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .listing-favorite:hover {
        background: white;
        transform: scale(1.1);
    }

    .listing-favorite.favorited {
        background: var(--danger);
        color: white;
    }

    .listing-content {
        padding: var(--spacing-sm);
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .listing-store {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: var(--spacing-xs);
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .listing-store a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
    }

    .listing-store a:hover {
        text-decoration: underline;
    }

    .listing-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xs);
    }

    .listing-price {
        font-weight: 800;
        color: var(--primary);
        font-size: 1rem;
    }

    .listing-location {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .listing-stock {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        display: inline-block;
        width: fit-content;
    }

    .stock-in {
        background: rgba(6, 214, 160, 0.1);
        color: var(--success);
        border: 1px solid rgba(6, 214, 160, 0.2);
    }

    .stock-low {
        background: rgba(255, 158, 31, 0.1);
        color: var(--warning);
        border: 1px solid rgba(255, 158, 31, 0.2);
    }

    .stock-out {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 71, 111, 0.2);
    }

    .listing-actions {
        display: flex;
        gap: 6px;
        margin-top: auto;
    }

    .action-button {
        flex: 1;
        padding: 6px 10px;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        text-decoration: none;
    }

    .action-view {
        background: var(--primary);
        color: white;
    }

    .action-view:hover {
        background: var(--primary-dark);
        color: white;
    }

    .action-cart {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .action-cart:hover {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    /* No Results State */
    .no-results {
        text-align: center;
        padding: var(--spacing-xl) var(--spacing-lg);
        color: var(--text-secondary);
        grid-column: 1 / -1;
    }

    .no-results-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
        color: var(--primary);
    }

    .no-results-title {
        font-size: 1.3rem;
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-weight: 700;
    }

    .no-results-description {
        margin-bottom: var(--spacing-md);
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    /* Enhanced Pagination with 1-5 + ellipsis */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: var(--spacing-lg);
    }

    .page-button {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: var(--radius-md);
        transition: var(--transition);
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.85rem;
        min-width: 40px;
        justify-content: center;
    }

    .page-button.active {
        background: var(--primary);
        border-color: transparent;
        color: white;
    }

    .page-button:not(.active):hover {
        background: var(--bg-secondary);
        border-color: var(--primary);
    }

    .page-ellipsis {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 6px;
        color: var(--text-secondary);
        font-weight: 600;
    }

    /* Mobile Filter Toggle */
    .mobile-filter-toggle {
        display: none;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        padding: var(--spacing-sm);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        width: 100%;
        margin-bottom: var(--spacing-md);
        justify-content: center;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.9rem;
    }

    .mobile-filter-toggle:hover {
        background: var(--primary-dark);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .listings-layout {
            grid-template-columns: 200px 1fr;
        }
        
        .listings-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 992px) {
        .listings-layout {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }

        .filters-sidebar {
            position: static;
            display: none;
        }

        .filters-sidebar.mobile-open {
            display: block;
        }

        .mobile-filter-toggle {
            display: flex;
        }

        .listings-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .listings-title {
            font-size: 2rem;
        }

        .listings-subtitle {
            font-size: 1rem;
        }

        .search-form {
            flex-direction: column;
        }

        .listings-header-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .sort-controls {
            width: 100%;
            justify-content: space-between;
        }

        .listings-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .listing-actions {
            flex-direction: column;
        }

        .active-filters {
            justify-content: center;
        }

        .pagination {
            flex-wrap: wrap;
        }
    }

    @media (max-width: 576px) {
        .listings-hero {
            padding: var(--spacing-lg) 0;
        }

        .listings-title {
            font-size: 1.8rem;
        }

        .search-section {
            padding: var(--spacing-md);
            margin: calc(-1 * var(--spacing-md)) auto var(--spacing-md);
        }

        .listing-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-xs);
        }

        .listing-content {
            padding: var(--spacing-sm);
        }

        .filter-group {
            margin-bottom: var(--spacing-sm);
        }
        
        .listing-image {
            height: 140px;
        }
        
        .listings-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 400px) {
        .listings-grid {
            grid-template-columns: 1fr;
        }
        
        .listing-image {
            height: 160px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="listings-hero scroll-animate">
    <div class="listings-hero-content">
        <h1 class="listings-title">Browse All Listings</h1>
        <p class="listings-subtitle">
            Discover {{ total_listings_count|default:"thousands of" }} amazing products from trusted sellers
        </p>
    </div>
</section>

<!-- Search Section -->
<section class="search-section scroll-animate">
    <form method="get" action="{% url 'all-listings' %}" class="search-form">
        <input type="text" name="q" class="search-input" 
               placeholder="Search products, brands, categories..." 
               value="{{ search_query|default:'' }}">
        <button type="submit" class="search-button">
            <i class="bi bi-search"></i>
            Search
        </button>
    </form>
</section>

<div class="container-custom">
    <!-- Mobile Filter Toggle -->
    <button class="mobile-filter-toggle" id="mobileFilterToggle">
        <i class="bi bi-sliders"></i>
        Show Filters
    </button>

    <div class="listings-layout">
        <!-- Ultra-Compact Filters Sidebar -->
        <aside class="filters-sidebar" id="filtersSidebar">
            <div class="filters-header">
                <h3 class="filters-title">
                    <i class="bi bi-sliders"></i>
                    Filters
                </h3>
            </div>
            <div class="filters-body">
                <!-- Category Filter -->
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="filter-select" id="category" name="category">
                        <option value="all" {% if not selected_category %}selected{% endif %}>All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Location Filter -->
                <div class="filter-group">
                    <label class="filter-label">Location</label>
                    <select class="filter-select" id="location" name="location">
                        <option value="all" {% if not selected_location %}selected{% endif %}>All Locations</option>
                        {% for location in locations %}
                        <option value="{{ location.code }}" {% if selected_location == location.code %}selected{% endif %}>
                            {{ location.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Price Range -->
                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <div class="price-range">
                        <input type="number" class="filter-input" id="min_price" name="min_price" 
                               value="{{ min_price|default:'' }}" placeholder="Min" min="0">
                        <input type="number" class="filter-input" id="max_price" name="max_price" 
                               value="{{ max_price|default:'' }}" placeholder="Max" min="0">
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="filter-group">
                    <label class="filter-label">Quick Price Ranges</label>
                    <div class="quick-filters">
                        <button type="button" class="quick-filter" data-min="0" data-max="1000">
                            Under KSh 1,000
                        </button>
                        <button type="button" class="quick-filter" data-min="1000" data-max="5000">
                            KSh 1,000 - 5,000
                        </button>
                        <button type="button" class="quick-filter" data-min="5000" data-max="10000">
                            KSh 5,000 - 10,000
                        </button>
                        <button type="button" class="quick-filter" data-min="10000" data-max="">
                            Over KSh 10,000
                        </button>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="button" id="apply-filters" class="filter-button filter-button-primary">
                        <i class="bi bi-check-lg"></i>Apply Filters
                    </button>
                    <button type="button" id="reset-filters" class="filter-button filter-button-secondary">
                        <i class="bi bi-arrow-clockwise"></i>Reset All
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Listings Header -->
            <div class="listings-header-bar scroll-animate">
                <div class="results-info">
                    <h2>All Listings</h2>
                    <div class="results-count" id="results-count">
                        {{ listings.paginator.count }} results found
                    </div>
                </div>
                <div class="sort-controls">
                    <span class="sort-label">Sort by:</span>
                    <select class="sort-select" id="sort-by">
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
                        <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Oldest First</option>
                        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Active Filters -->
            <div class="active-filters" id="active-filters">
                {% if search_query %}
                <div class="filter-tag">
                    Search: "{{ search_query }}"
                    <button type="button" class="filter-tag-remove remove-filter" data-filter="q">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                {% endif %}
                
                {% if selected_category and selected_category != 'all' %}
                {% for category in categories %}
                    {% if category.id == selected_category|add:0 %}
                    <div class="filter-tag">
                        Category: {{ category.name }}
                        <button type="button" class="filter-tag-remove remove-filter" data-filter="category">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    {% endif %}
                {% endfor %}
                {% endif %}
            </div>

            <!-- Listings Grid -->
            <div class="listings-grid" id="listings-container">
                {% for listing in listings %}
                <article class="listing-card scroll-animate">
                    <div class="listing-image">
                        <img src="{{ listing.get_image_url }}" 
                             alt="{{ listing.title }}"
                             data-placeholder="{% static 'images/listing_placeholder.svg' %}"
                             onerror="this.onerror=null; this.src=this.getAttribute('data-placeholder');"
                             loading="lazy">
                        
                        <!-- Title Overlay on Image -->
                        <div class="listing-title-overlay">
                            <h3 class="listing-title">{{ listing.title }}</h3>
                        </div>
                        
                        <div class="listing-badges">
                            <span class="listing-category">
                                <i class="bi {{ listing.category.icon|default:'bi-grid' }}"></i>
                                {{ listing.category.name }}
                            </span>
                            <div class="listing-status">
                                {% if listing.is_sold %}
                                <span class="listing-sold">Sold</span>
                                {% endif %}
                                <form action="{% url 'toggle_favorite' listing.id %}" method="post" class="favorite-form">
                                    {% csrf_token %}
                                    <button type="submit" class="listing-favorite {% if listing.id in user_favorites %}favorited{% endif %}">
                                        <i class="bi bi-heart{% if listing.id in user_favorites %}-fill{% endif %}"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="listing-content">
                        {% if listing.store %}
                        <div class="listing-store">
                            <i class="bi bi-shop"></i>
                            <a href="{% url 'storefront:store_detail' listing.store.slug %}">{{ listing.store.name }}</a>
                        </div>
                        {% endif %}
                        
                        <div class="listing-meta">
                            <span class="listing-price">KSh {{ listing.price|intcomma }}</span>
                            <span class="listing-location">
                                <i class="bi bi-geo-alt"></i>
                                {{ listing.get_location_display }}
                            </span>
                        </div>
                        
                        <div class="listing-stock {% if listing.stock > 10 %}stock-in{% elif listing.stock > 0 %}stock-low{% else %}stock-out{% endif %}">
                            {% if listing.stock > 10 %}
                                In Stock
                            {% elif listing.stock > 0 %}
                                Low Stock
                            {% else %}
                                Out of Stock
                            {% endif %}
                        </div>
                        
                        <div class="listing-actions">
                            <a href="{% url 'listing-detail' listing.pk %}" class="action-button action-view">
                                <i class="bi bi-eye"></i>
                                View
                            </a>
                            {% if user.is_authenticated and not listing.is_sold and listing.stock > 0 and listing.seller != user %}
                            <form action="{% url 'add_to_cart' listing.id %}" method="post" class="d-flex flex-1">
                                {% csrf_token %}
                                <button type="submit" class="action-button action-cart w-100">
                                    <i class="bi bi-cart-plus"></i>
                                    Cart
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </article>
                {% empty %}
                <div class="no-results">
                    <div class="no-results-icon">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3 class="no-results-title">No listings found</h3>
                    <p class="no-results-description">
                        Try adjusting your search filters or check back later for new listings.
                    </p>
                    <button id="reset-all-filters" class="filter-button filter-button-primary">
                        <i class="bi bi-arrow-clockwise"></i>Reset All Filters
                    </button>
                </div>
                {% endfor %}
            </div>

            <!-- Enhanced Pagination with 1-5 + ellipsis -->
            {% if listings.has_other_pages %}
            <nav class="pagination" aria-label="Listings pagination">
                {% if listings.has_previous %}
                <a class="page-button" href="?page={{ listings.previous_page_number }}" data-page="{{ listings.previous_page_number }}">
                    <i class="bi bi-chevron-left"></i> Prev
                </a>
                {% else %}
                <span class="page-button" aria-disabled="true">
                    <i class="bi bi-chevron-left"></i> Prev
                </span>
                {% endif %}

                <!-- Always show pages 1-5 -->
                {% for i in listings.paginator.page_range %}
                    {% if forloop.counter <= 5 %}
                        {% if listings.number == i %}
                        <span class="page-button active">{{ i }}</span>
                        {% else %}
                        <a class="page-button" href="?page={{ i }}" data-page="{{ i }}">{{ i }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <!-- Show ellipsis if there are more than 5 pages -->
                {% if listings.paginator.num_pages > 5 %}
                <span class="page-ellipsis">...</span>
                {% endif %}

                {% if listings.has_next %}
                <a class="page-button" href="?page={{ listings.next_page_number }}" data-page="{{ listings.next_page_number }}">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
                {% else %}
                <span class="page-button" aria-disabled="true">
                    Next <i class="bi bi-chevron-right"></i>
                </span>
                {% endif %}
            </nav>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mobile filter toggle
    const mobileFilterToggle = document.getElementById('mobileFilterToggle');
    const filtersSidebar = document.getElementById('filtersSidebar');
    
    if (mobileFilterToggle && filtersSidebar) {
        mobileFilterToggle.addEventListener('click', function() {
            filtersSidebar.classList.toggle('mobile-open');
            const isOpen = filtersSidebar.classList.contains('mobile-open');
            this.innerHTML = isOpen ? 
                '<i class="bi bi-x-lg"></i>Hide Filters' : 
                '<i class="bi bi-sliders"></i>Show Filters';
        });
    }

    // Quick price range buttons
    document.querySelectorAll('.quick-filter').forEach(filter => {
        filter.addEventListener('click', function() {
            const min = this.getAttribute('data-min');
            const max = this.getAttribute('data-max');
            
            document.getElementById('min_price').value = min;
            document.getElementById('max_price').value = max || '';
            
            // Trigger filter application
            document.getElementById('apply-filters').click();
        });
    });

    // Apply filters button
    document.getElementById('apply-filters').addEventListener('click', function() {
        const category = document.getElementById('category').value;
        const location = document.getElementById('location').value;
        const minPrice = document.getElementById('min_price').value;
        const maxPrice = document.getElementById('max_price').value;
        const sortBy = document.getElementById('sort-by').value;
        
        // Build URL with parameters
        const params = new URLSearchParams();
        
        if (category && category !== 'all') params.append('category', category);
        if (location && location !== 'all') params.append('location', location);
        if (minPrice) params.append('min_price', minPrice);
        if (maxPrice) params.append('max_price', maxPrice);
        if (sortBy) params.append('sort_by', sortBy);
        
        // Get search query from search form
        const searchInput = document.querySelector('.search-input');
        if (searchInput && searchInput.value) {
            params.append('q', searchInput.value);
        }
        
        // Navigate to filtered page
        window.location.href = `{% url 'all-listings' %}?${params.toString()}`;
    });

    // Reset filters button
    document.getElementById('reset-filters').addEventListener('click', function() {
        document.getElementById('category').value = 'all';
        document.getElementById('location').value = 'all';
        document.getElementById('min_price').value = '';
        document.getElementById('max_price').value = '';
        document.getElementById('sort-by').value = 'newest';
        
        const searchInput = document.querySelector('.search-input');
        if (searchInput) searchInput.value = '';
        
        window.location.href = '{% url 'all-listings' %}';
    });

    // Reset all filters from no results state
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'reset-all-filters') {
            document.getElementById('reset-filters').click();
        }
    });

    // Remove filter tags
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-filter')) {
            const filterName = e.target.closest('.remove-filter').getAttribute('data-filter');
            
            if (filterName === 'category' || filterName === 'location') {
                document.getElementById(filterName).value = 'all';
            } else if (filterName === 'q') {
                const searchInput = document.querySelector('.search-input');
                if (searchInput) searchInput.value = '';
            } else {
                document.getElementById(filterName).value = '';
            }
            
            document.getElementById('apply-filters').click();
        }
    });

    // Sort change handler
    document.getElementById('sort-by').addEventListener('change', function() {
        document.getElementById('apply-filters').click();
    });

    // Favorite button animations
    document.querySelectorAll('.listing-favorite').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            const icon = this.querySelector('i');
            
            // Add click animation
            this.style.transform = 'scale(0.9)';
            
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                // Reset animation
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
                
                if (data.is_favorited) {
                    this.classList.add('favorited');
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                } else {
                    this.classList.remove('favorited');
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Scroll animations
    const scrollElements = document.querySelectorAll('.scroll-animate');
    
    const elementInView = (el, dividend = 1) => {
        const elementTop = el.getBoundingClientRect().top;
        return (
            elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend
        );
    };
    
    const displayScrollElement = (element) => {
        element.classList.add('animated');
    };
    
    const handleScrollAnimation = () => {
        scrollElements.forEach((el) => {
            if (elementInView(el, 1.25)) {
                displayScrollElement(el);
            }
        });
    };
    
    window.addEventListener('scroll', () => {
        handleScrollAnimation();
    });
    
    // Initial check
    handleScrollAnimation();
});
</script>
{% endblock %}