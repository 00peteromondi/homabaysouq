{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Listing - HomaBay Souq{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white py-3">
                    <h2 class="h4 mb-0"><i class="bi bi-plus-circle me-2"></i> {% if object %}Edit{% else %}Create{% endif %} Listing</h2>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.title|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.price|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.condition|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.stock|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.delivery_option|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.category|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.location|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description|as_crispy_field }}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.image.id_for_label }}" class="form-label">Listing Image*</label>
                            <div class="file-drop-area" id="imageUploadArea">
                                <span class="file-msg">Drag & drop an image here or click to browse</span>
                                <input type="file" name="{{ form.image.name }}" id="{{ form.image.id_for_label }}" class="file-input" accept="image/*" {% if not form.image.value %}required{% endif %}>
                            </div>
                            {% if form.image.value %}
                            <div class="mt-2">
                                <small class="text-muted">Current image:</small>
                                <img src="{{ form.image.value.url }}" alt="Current listing image" class="img-thumbnail mt-1" style="max-height: 100px;">
                            </div>
                            {% endif %}
                            {% if form.image.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.image.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="{% if object %}{% url 'listing-detail' object.pk %}{% else %}{% url 'home' %}{% endif %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i> {% if object %}Update{% else %}Create{% endif %} Listing
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Tips Card -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-1"></i> Listing Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Use clear, well-lit photos</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Write a detailed description</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Set a reasonable price</li>
                        <li><i class="bi bi-check-circle text-success me-1"></i> Choose the right category and location</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.file-drop-area {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    transition: all 0.3s;
    background-color: #f8f9fa;
    text-align: center;
    cursor: pointer;
}

.file-drop-area:hover {
    border-color: #4e73df;
    background-color: #e9ecef;
}

.file-msg {
    font-size: 0.9rem;
    color: #6c757d;
}

.file-input {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    opacity: 0;
    cursor: pointer;
}
</style>

<script>
// Enhanced file upload UI
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('.file-input');
    const fileMsg = document.querySelector('.file-msg');
    const fileDropArea = document.getElementById('imageUploadArea');
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileMsg.textContent = this.files[0].name;
        } else {
            fileMsg.textContent = 'Drag & drop an image here or click to browse';
        }
    });
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        fileDropArea.classList.add('bg-primary', 'bg-opacity-10');
        fileDropArea.style.borderColor = '#4e73df';
    }
    
    function unhighlight() {
        fileDropArea.classList.remove('bg-primary', 'bg-opacity-10');
        fileDropArea.style.borderColor = '#dee2e6';
    }
    
    // Handle dropped files
    fileDropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        
        if (files.length > 0) {
            fileMsg.textContent = files[0].name;
        }
    }
});
</script>
{% endblock %}